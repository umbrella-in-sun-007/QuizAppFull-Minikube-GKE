# GCP Cloud SQL Setup for QuizApp

Complete setup for using Google Cloud SQL with your Wagtail QuizApp, supporting both local development and production deployment.

## ğŸ“‹ Overview

This setup enables your application to use a **single Cloud SQL database instance** for both:
- **Local development** (via Docker Compose with Cloud SQL Proxy)
- **Production deployment** (via GKE with Cloud SQL Connector)

**Architecture:**
```
Cloud SQL Instance (quizapp-postgres-prod)
â”œâ”€â”€ dev database  â† Local Docker Compose
â””â”€â”€ prod database â† GKE Production
```

## ğŸš€ Quick Start

### Option 1: Automated Setup (Recommended)

```bash
# 1. Install gcloud CLI (see PREREQUISITES.md)
# 2. Run the automated setup script
./setup-cloud-sql.sh
```

The script will:
- Create Cloud SQL instance with dev/prod databases
- Set up database users and secure passwords
- Create service account for local access
- Generate `.env` file with all credentials
- Configure everything automatically

### Option 2: Manual Setup

Follow the step-by-step guide in `MANUAL_SETUP.md` for full control over each step.

## ğŸ“š Documentation

| File                              | Purpose                                   |
| --------------------------------- | ----------------------------------------- |
| `PREREQUISITES.md`                | Install gcloud CLI and Cloud SQL Proxy    |
| `CLOUD_SQL_SETUP.md`              | Quick start guide with essential commands |
| `MANUAL_SETUP.md`                 | Step-by-step manual setup instructions    |
| `setup-cloud-sql.sh`              | Automated setup script                    |
| `gcp-database-migration-guide.md` | Comprehensive technical guide             |

## ğŸ—ï¸ Architecture

### Local Development
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ docker-compose.cloud-sql.yml        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   web    â”‚ â†â†’ â”‚ cloud-sql-proxyâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
                 GCP Cloud SQL
                  (dev database)
```

### Production (GKE)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kubernetes Pod                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ web  â”‚ â†â†’ â”‚ cloud-sql-proxy  â”‚  â”‚
â”‚  â”‚      â”‚    â”‚   (sidecar)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
              GCP Cloud SQL
              (prod database)
```

## ğŸ”§ Configuration Files

### New Files for Cloud SQL Setup

- **`docker-compose.cloud-sql.yml`** - Docker Compose with Cloud SQL Proxy
- **`quizapp/settings/dev.py`** - Dev settings with Cloud SQL config
- **`k8s/deployment-cloud-sql.yaml`** - GKE deployment manifest
- **`env.template`** - Environment variables template

### Environment Variables

Required in `.env` file (created by setup script):

```bash
CONNECTION_NAME=project:region:instance
GCP_KEY_PATH=./gcp-key.json
DEV_DB_PASSWORD=<auto-generated>
DJANGO_SECRET_KEY=<auto-generated>
DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1
```

## ğŸš¦ Getting Started

### 1. Install Prerequisites

```bash
# See PREREQUISITES.md for detailed instructions
# Install gcloud CLI
curl https://sdk.cloud.google.com | bash

# Install Cloud SQL Proxy
curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.8.0/cloud-sql-proxy.linux.amd64
chmod +x cloud-sql-proxy
sudo mv cloud-sql-proxy /usr/local/bin/
```

### 2. Run Setup

```bash
# Automated
./setup-cloud-sql.sh

# OR Manual
# Follow MANUAL_SETUP.md
```

### 3. Start Development Environment

```bash
# Start services
docker-compose -f docker-compose.cloud-sql.yml up -d

# Run migrations
docker-compose -f docker-compose.cloud-sql.yml exec web python manage.py migrate

# Create superuser
docker-compose -f docker-compose.cloud-sql.yml exec web python manage.py createsuperuser

# Access application
http://localhost:8000
http://localhost:8000/admin
```

### 4. Deploy to Production (Optional)

See `gcp-database-migration-guide.md` for complete GKE deployment instructions.

## ğŸ“Š Database Access

### Via gcloud (Direct)

```bash
# Dev database
gcloud sql connect quizapp-postgres-prod --user=dev_user --database=dev

# Prod database
gcloud sql connect quizapp-postgres-prod --user=prod_user --database=prod
```

### Via psql (with Cloud SQL Proxy)

```bash
# Start proxy
cloud-sql-proxy <CONNECTION_NAME> --port 5433 &

# Connect to dev
PGPASSWORD=<DEV_PASSWORD> psql -h 127.0.0.1 -p 5433 -U dev_user -d dev
```

### From Application

Local development automatically connects via the Cloud SQL Proxy sidecar container.

## ğŸ”„ Common Operations

### Start Local Development

```bash
docker-compose -f docker-compose.cloud-sql.yml up -d
```

### Stop Local Development

```bash
docker-compose -f docker-compose.cloud-sql.yml down
```

### View Logs

```bash
# All logs
docker-compose -f docker-compose.cloud-sql.yml logs -f

# Cloud SQL Proxy only
docker-compose -f docker-compose.cloud-sql.yml logs -f cloud-sql-proxy

# Web app only
docker-compose -f docker-compose.cloud-sql.yml logs -f web
```

### Run Django Commands

```bash
# Migrations
docker-compose -f docker-compose.cloud-sql.yml exec web python manage.py migrate

# Shell
docker-compose -f docker-compose.cloud-sql.yml exec web python manage.py shell

# Create superuser
docker-compose -f docker-compose.cloud-sql.yml exec web python manage.py createsuperuser
```

### Sync Data from Dev to Prod

```bash
# Export from dev
docker-compose -f docker-compose.cloud-sql.yml exec web \
    python manage.py dumpdata --natural-foreign > backup.json

# Import to prod (on GKE)
kubectl cp backup.json <POD_NAME>:/tmp/
kubectl exec -it <POD_NAME> -- python manage.py loaddata /tmp/backup.json
```

## ğŸ” Security

1. **Never commit** `.env` or `gcp-key.json` to version control
2. **Rotate passwords** regularly via Secret Manager
3. **Use Workload Identity** for GKE (no keys needed)
4. **Restrict access** using authorized networks
5. **Enable SSL** for production connections

## ğŸ’° Cost Estimation

### Development Setup
- Instance: `db-g1-small` - ~$50/month
- Storage: 20GB SSD - ~$3.40/month
- Backups: 20GB - ~$1.60/month
- **Total: ~$55/month**

### Production HA Setup
- Instance: `db-custom-2-7680` (HA) - ~$400/month
- Storage: 50GB SSD - ~$8.50/month
- Backups: 50GB - ~$4/month
- **Total: ~$412/month**

**Cost Optimization:**
- Stop instance when not in use (dev/test): `gcloud sql instances patch <name> --activation-policy=NEVER`
- Use smaller tier for testing: `db-f1-micro` (~$10/month)

## ğŸ› Troubleshooting

### Cloud SQL Proxy won't connect

```bash
# Check proxy logs
docker-compose -f docker-compose.cloud-sql.yml logs cloud-sql-proxy

# Verify service account permissions
gcloud projects get-iam-policy <PROJECT_ID> | grep quizapp-local-dev

# Test proxy manually
cloud-sql-proxy <CONNECTION_NAME> --port 5433
```

### Application can't reach database

```bash
# Check network connectivity
docker-compose -f docker-compose.cloud-sql.yml exec web nc -zv cloud-sql-proxy 5432

# Verify environment variables
docker-compose -f docker-compose.cloud-sql.yml exec web env | grep DB_
```

### Permission denied errors

```bash
# Check Cloud SQL instance is running
gcloud sql instances describe quizapp-postgres-prod

# Verify user exists
gcloud sql users list --instance=quizapp-postgres-prod
```

## ğŸ“– Additional Resources

- [Cloud SQL Documentation](https://cloud.google.com/sql/docs)
- [Cloud SQL Proxy](https://cloud.google.com/sql/docs/postgres/sql-proxy)
- [Django on GCP](https://cloud.google.com/python/django)
- [Wagtail Deployment](https://docs.wagtail.org/en/stable/advanced_topics/deploying.html)

## ğŸ†˜ Support

For detailed troubleshooting, see:
- `MANUAL_SETUP.md` - Detailed manual steps
- `gcp-database-migration-guide.md` - Comprehensive guide
- [GCP Support](https://cloud.google.com/support)

## âœ… Verification Checklist

After setup, verify:

- [ ] gcloud CLI installed and authenticated
- [ ] Cloud SQL instance created and running
- [ ] Dev and prod databases exist
- [ ] Service account created with correct permissions
- [ ] Cloud SQL Proxy installed
- [ ] `.env` file created with credentials
- [ ] Docker Compose starts successfully
- [ ] Can connect to database from application
- [ ] Migrations run successfully
- [ ] Can create and login as superuser

## ğŸ”„ Migration from Current Setup

If migrating from local PostgreSQL (docker-compose.yml):

1. Export existing data:
   ```bash
   docker-compose exec db pg_dump -U postgres quizapp > backup.sql
   ```

2. Set up Cloud SQL (follow this guide)

3. Import data to dev database:
   ```bash
   PGPASSWORD=<DEV_PASSWORD> psql -h 127.0.0.1 -p 5433 \
       -U dev_user -d dev < backup.sql
   ```

4. Switch to new docker-compose file:
   ```bash
   docker-compose down
   docker-compose -f docker-compose.cloud-sql.yml up -d
   ```

---

**Ready to Get Started?**

1. Install prerequisites: See `PREREQUISITES.md`
2. Run setup: `./setup-cloud-sql.sh`
3. Start developing: `docker-compose -f docker-compose.cloud-sql.yml up -d`
