{% extends "base.html" %}

{% block extra_css %}
<style>
    body {
        padding-top: 0;
    }
    
    /* Quiz Header - Sticky */
    .quiz-header {
        background-color: #2c3e50;
        color: #fff;
        padding: 15px 20px;
        border-bottom: 3px solid #3498db;
        position: sticky;
        top: 0;
        z-index: 100;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .quiz-header-title {
        flex: 1;
        min-width: 200px;
    }
    
    .quiz-header-title h1 {
        color: #fff;
        font-size: 20px;
        margin: 0;
        border: none;
        padding: 0;
    }
    
    .quiz-header-info {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .quiz-info-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
    }
    
    .quiz-info-item strong {
        color: #3498db;
    }
    
    /* Timer Display */
    .timer-display {
        background-color: #34495e;
        padding: 8px 15px;
        border: 2px solid #3498db;
        font-size: 18px;
        font-weight: bold;
        min-width: 120px;
        text-align: center;
    }
    
    .timer-display.warning {
        background-color: #e74c3c;
        border-color: #c0392b;
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    /* Main Quiz Container */
    .quiz-container {
        display: flex;
        gap: 20px;
        max-width: 1400px;
        margin: 20px auto;
        padding: 0 20px;
    }
    
    /* Question Navigator Sidebar */
    .question-navigator {
        flex: 0 0 250px;
        position: sticky;
        top: 80px;
        height: fit-content;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }
    
    .nav-card {
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 15px;
    }
    
    .nav-card h3 {
        font-size: 16px;
        margin-bottom: 15px;
        color: #2c3e50;
        border-bottom: 2px solid #3498db;
        padding-bottom: 8px;
    }
    
    .question-nav-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-bottom: 15px;
    }
    
    .question-nav-btn {
        padding: 8px;
        border: 1px solid #bdc3c7;
        background-color: #fff;
        cursor: pointer;
        font-size: 13px;
        font-weight: bold;
        text-align: center;
        transition: all 0.2s;
    }
    
    .question-nav-btn:hover {
        background-color: #ecf0f1;
    }
    
    .question-nav-btn.current {
        background-color: #3498db;
        color: #fff;
        border-color: #2980b9;
    }
    
    .question-nav-btn.answered {
        background-color: #27ae60;
        color: #fff;
        border-color: #229954;
    }
    
    .question-nav-btn.unanswered {
        background-color: #fff;
        color: #7f8c8d;
    }
    
    .nav-legend {
        font-size: 12px;
        color: #7f8c8d;
        padding-top: 10px;
        border-top: 1px solid #ddd;
    }
    
    .nav-legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 5px 0;
    }
    
    .nav-legend-color {
        width: 20px;
        height: 20px;
        border: 1px solid #bdc3c7;
    }
    
    /* Questions Area */
    .questions-area {
        flex: 1;
        min-width: 0;
    }
    
    .question-container {
        display: none;
    }
    
    .question-container.active {
        display: block;
    }
    
    .question-card {
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 30px;
        margin-bottom: 20px;
    }
    
    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #3498db;
    }
    
    .question-number {
        font-size: 16px;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .question-required {
        color: #e74c3c;
        font-size: 14px;
    }
    
    .question-marks {
        background-color: #3498db;
        color: #fff;
        padding: 4px 12px;
        font-size: 13px;
        font-weight: bold;
        border: 1px solid #2980b9;
    }
    
    .question-text {
        background-color: #f9f9f9;
        padding: 20px;
        margin: 20px 0;
        border-left: 4px solid #3498db;
        font-size: 16px;
        line-height: 1.8;
    }
    
    .question-type-hint {
        color: #7f8c8d;
        font-size: 14px;
        font-style: italic;
        margin-bottom: 15px;
        padding: 8px;
        background-color: #ecf0f1;
        border-left: 3px solid #95a5a6;
    }
    
    .options-container {
        margin-top: 20px;
    }
    
    .option-item {
        background-color: #fff;
        border: 2px solid #ddd;
        padding: 15px;
        margin: 10px 0;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .option-item:hover {
        background-color: #f8f9fa;
        border-color: #3498db;
    }
    
    .option-item input[type="radio"]:checked ~ label,
    .option-item input[type="checkbox"]:checked ~ label {
        font-weight: bold;
        color: #2c3e50;
    }
    
    .option-item input[type="radio"]:checked,
    .option-item input[type="checkbox"]:checked {
        accent-color: #3498db;
    }
    
    .option-item label {
        cursor: pointer;
        flex: 1;
        margin: 0;
        font-size: 15px;
    }
    
    .answer-textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid #ddd;
        font-size: 15px;
        font-family: Arial, sans-serif;
        min-height: 120px;
        resize: vertical;
    }
    
    .answer-textarea:focus {
        border-color: #3498db;
        outline: none;
    }
    
    /* Navigation Buttons */
    .question-navigation {
        display: flex;
        justify-content: space-between;
        gap: 15px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #ddd;
    }
    
    .nav-btn-group {
        display: flex;
        gap: 10px;
    }
    
    .btn-nav {
        padding: 12px 25px;
        font-size: 15px;
        font-weight: bold;
        border: 1px solid;
        cursor: pointer;
        background-color: #95a5a6;
        color: #fff;
        border-color: #7f8c8d;
    }
    
    .btn-nav:hover:not(:disabled) {
        background-color: #7f8c8d;
    }
    
    .btn-nav:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .btn-nav-primary {
        background-color: #3498db;
        border-color: #2980b9;
    }
    
    .btn-nav-primary:hover:not(:disabled) {
        background-color: #2980b9;
    }
    
    .btn-submit {
        background-color: #27ae60;
        border-color: #229954;
        padding: 12px 30px;
        font-size: 16px;
        font-weight: bold;
        color: #fff;
        cursor: pointer;
    }
    
    .btn-submit:hover {
        background-color: #229954;
    }
    
    /* Submit Section */
    .submit-section {
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 30px;
        text-align: center;
        display: none;
    }
    
    .submit-section.active {
        display: block;
    }
    
    .submit-summary {
        background-color: #ecf0f1;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #bdc3c7;
    }
    
    .submit-summary h2 {
        color: #2c3e50;
        margin-bottom: 15px;
    }
    
    .summary-stats {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin: 20px 0;
        font-size: 16px;
    }
    
    .summary-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .summary-stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #3498db;
    }
    
    .summary-stat-label {
        color: #7f8c8d;
        margin-top: 5px;
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
        .quiz-container {
            flex-direction: column;
        }
        
        .question-navigator {
            position: static;
            flex: 1;
            max-height: none;
        }
        
        .question-nav-grid {
            grid-template-columns: repeat(8, 1fr);
        }
    }
    
    @media (max-width: 768px) {
        .quiz-header {
            flex-direction: column;
            gap: 10px;
        }
        
        .quiz-header-info {
            width: 100%;
            justify-content: space-between;
        }
        
        .question-nav-grid {
            grid-template-columns: repeat(6, 1fr);
        }
        
        .question-card {
            padding: 20px;
        }
        
        .question-navigation {
            flex-direction: column;
        }
        
        .nav-btn-group {
            width: 100%;
        }
        
        .btn-nav {
            flex: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Quiz Header -->
<div class="quiz-header">
    <div class="quiz-header-title">
        <h1>{{ quiz.title }}</h1>
    </div>
    <div class="quiz-header-info">
        <div class="quiz-info-item">
            <strong>Questions:</strong> <span>{{ questions|length }}</span>
        </div>
        <div class="quiz-info-item">
            <strong>Marks:</strong> <span>{{ quiz.get_total_marks }}</span>
        </div>
        <div class="timer-display" id="timer">
            <span id="timeLeft">Loading...</span>
        </div>
    </div>
</div>

<!-- Main Quiz Container -->
<div class="quiz-container">
    <!-- Question Navigator Sidebar -->
    <div class="question-navigator">
        <div class="nav-card">
            <h3>Question Navigator</h3>
            <div class="question-nav-grid" id="questionNavGrid">
                {% for question in questions %}
                <button type="button" class="question-nav-btn" data-question="{{ forloop.counter }}" onclick="goToQuestion({{ forloop.counter }})">
                    {{ forloop.counter }}
                </button>
                {% endfor %}
            </div>
            <div class="nav-legend">
                <div class="nav-legend-item">
                    <div class="nav-legend-color" style="background-color: #3498db;"></div>
                    <span>Current</span>
                </div>
                <div class="nav-legend-item">
                    <div class="nav-legend-color" style="background-color: #27ae60;"></div>
                    <span>Answered</span>
                </div>
                <div class="nav-legend-item">
                    <div class="nav-legend-color" style="background-color: #fff;"></div>
                    <span>Not Answered</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Questions Area -->
    <div class="questions-area">
        <form method="post" id="quizForm">
            {% csrf_token %}
            
            {% for question in questions %}
            <div class="question-container" data-question="{{ forloop.counter }}">
                <div class="question-card">
                    <div class="question-header">
                        <div>
                            <div class="question-number">
                                Question {{ forloop.counter }}
                                {% if question.is_required %}
                                <span class="question-required">* Required</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="question-marks">{{ question.marks }} marks</div>
                    </div>
                    
                    <div class="question-text">
                        {{ question.question_text|safe }}
                    </div>
                    
                    {% if question.question_type == 'single' or question.question_type == 'true_false' %}
                        <div class="question-type-hint">Select one answer</div>
                        <div class="options-container">
                            {% for option in question.options.all %}
                            <div class="option-item">
                                <input type="radio" name="question_{{ question.id }}" 
                                       id="opt_{{ option.id }}" value="{{ option.id }}"
                                       {% if question.is_required %}required{% endif %}
                                       onchange="markAnswered({{ forloop.parentloop.counter }})">
                                <label for="opt_{{ option.id }}">{{ option.option_text }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    
                    {% elif question.question_type == 'multiple' %}
                        <div class="question-type-hint">Select all that apply</div>
                        <div class="options-container">
                            {% for option in question.options.all %}
                            <div class="option-item">
                                <input type="checkbox" name="question_{{ question.id }}" 
                                       id="opt_{{ option.id }}" value="{{ option.id }}"
                                       onchange="markAnswered({{ forloop.parentloop.counter }})">
                                <label for="opt_{{ option.id }}">{{ option.option_text }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    
                    {% elif question.question_type == 'short_answer' %}
                        <div class="question-type-hint">Type your answer below</div>
                        <div class="options-container">
                            <textarea name="question_{{ question.id }}" class="answer-textarea"
                                      placeholder="Enter your answer here..."
                                      {% if question.is_required %}required{% endif %}
                                      oninput="markAnswered({{ forloop.counter }})"></textarea>
                        </div>
                    {% endif %}
                    
                    <div class="question-navigation">
                        <button type="button" class="btn-nav" onclick="previousQuestion()" id="prevBtn">
                            ← Previous
                        </button>
                        <div class="nav-btn-group">
                            <button type="button" class="btn-nav btn-nav-primary" onclick="nextQuestion()" id="nextBtn">
                                Next →
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <!-- Submit Section -->
            <div class="submit-section" id="submitSection">
                <div class="submit-summary">
                    <h2>Review Your Answers</h2>
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <div class="summary-stat-value" id="totalQuestions">{{ questions|length }}</div>
                            <div class="summary-stat-label">Total Questions</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value" id="answeredTotal">0</div>
                            <div class="summary-stat-label">Answered</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value" id="unansweredTotal">{{ questions|length }}</div>
                            <div class="summary-stat-label">Not Answered</div>
                        </div>
                    </div>
                    <p style="color: #7f8c8d; margin-top: 15px;">
                        Please review your answers before submitting. You can navigate back to any question using the question navigator.
                    </p>
                </div>
                <button type="submit" class="btn-submit" onclick="return confirm('Are you sure you want to submit? You cannot change your answers after submission.');">
                    Submit Quiz
                </button>
                <br><br>
                <button type="button" class="btn-nav" onclick="goToQuestion({{ questions|length }})">
                    ← Back to Questions
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentQuestionNum = 1;
const totalQuestions = {{ questions|length }};
const answeredQuestions = new Set();

// Get CSRF token for AJAX requests
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Timer - Backend Managed
let timeLeft = {{ time_remaining_seconds }};
const timerEl = document.getElementById('timeLeft');
const timerDisplay = document.getElementById('timer');
const attemptId = {{ attempt.id }};
const checkTimeUrl = "{% url 'check_quiz_time' attempt.id %}";

// Sync with backend every 10 seconds
function syncTimeWithBackend() {
    fetch(checkTimeUrl)
        .then(response => response.json())
        .then(data => {
            if (data.expired || data.completed) {
                alert('Time up! Your quiz will be submitted automatically.');
                document.getElementById('quizForm').submit();
            } else {
                // Update local timer with backend time
                timeLeft = data.time_remaining;
            }
        })
        .catch(error => {
            console.error('Error syncing time with backend:', error);
        });
}

// Sync with backend every 10 seconds
setInterval(syncTimeWithBackend, 10000);

function updateTimer() {
    const mins = Math.floor(timeLeft / 60);
    const secs = timeLeft % 60;
    timerEl.textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
    
    if (timeLeft <= 60) {
        timerDisplay.classList.add('warning');
    }
    
    if (timeLeft <= 0) {
        alert('Time up! Your quiz will be submitted automatically.');
        document.getElementById('quizForm').submit();
        return; // Stop the timer
    }
    
    timeLeft--;
}

// Update timer display every second
setInterval(updateTimer, 1000);
updateTimer();

// Also check backend time before form submission
document.getElementById('quizForm').addEventListener('submit', function(e) {
    // Let the form submit - backend will validate time
    // This is just to show a loading state
    const submitBtn = document.querySelector('.btn-submit');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
    }
});

// Question Navigation
function showQuestion(questionNum) {
    // Hide all questions
    document.querySelectorAll('.question-container').forEach(q => q.classList.remove('active'));
    document.getElementById('submitSection').classList.remove('active');
    
    // Show current question
    const questionToShow = document.querySelector(`.question-container[data-question="${questionNum}"]`);
    if (questionToShow) {
        questionToShow.classList.add('active');
        currentQuestionNum = questionNum;
        
        // Update progress
        updateProgress();
        
        // Update nav buttons
        updateNavButtons();
        
        // Update navigator
        updateNavigator();
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function goToQuestion(questionNum) {
    if (questionNum >= 1 && questionNum <= totalQuestions) {
        showQuestion(questionNum);
    } else if (questionNum > totalQuestions) {
        showSubmitSection();
    }
}

function nextQuestion() {
    if (currentQuestionNum < totalQuestions) {
        goToQuestion(currentQuestionNum + 1);
    } else {
        showSubmitSection();
    }
}

function previousQuestion() {
    if (currentQuestionNum > 1) {
        goToQuestion(currentQuestionNum - 1);
    }
}

function showSubmitSection() {
    document.querySelectorAll('.question-container').forEach(q => q.classList.remove('active'));
    document.getElementById('submitSection').classList.add('active');
    
    // Update summary stats
    document.getElementById('answeredTotal').textContent = answeredQuestions.size;
    document.getElementById('unansweredTotal').textContent = totalQuestions - answeredQuestions.size;
    
    // Update navigator
    document.querySelectorAll('.question-nav-btn').forEach(btn => btn.classList.remove('current'));
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateProgress() {
    // Progress bar removed - no action needed
}

function updateNavButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    prevBtn.disabled = currentQuestionNum === 1;
    nextBtn.textContent = currentQuestionNum === totalQuestions ? 'Review & Submit →' : 'Next →';
}

function updateNavigator() {
    document.querySelectorAll('.question-nav-btn').forEach(btn => {
        const qNum = parseInt(btn.dataset.question);
        btn.classList.remove('current', 'answered', 'unanswered');
        
        if (qNum === currentQuestionNum) {
            btn.classList.add('current');
        } else if (answeredQuestions.has(qNum)) {
            btn.classList.add('answered');
        } else {
            btn.classList.add('unanswered');
        }
    });
}

function markAnswered(questionNum) {
    answeredQuestions.add(questionNum);
    updateProgress();
    updateNavigator();
}

// Initialize
showQuestion(1);

// Make option items clickable
document.addEventListener('click', function(e) {
    const optionItem = e.target.closest('.option-item');
    if (optionItem) {
        const input = optionItem.querySelector('input[type="radio"], input[type="checkbox"]');
        if (input && e.target !== input) {
            if (input.type === 'radio') {
                input.checked = true;
            } else if (input.type === 'checkbox') {
                input.checked = !input.checked;
            }
            // Trigger the onchange event to mark question as answered
            input.dispatchEvent(new Event('change'));
        }
    }
});

// Fullscreen functionality
function enterFullscreen() {
    const elem = document.documentElement;
    if (elem.requestFullscreen) {
        elem.requestFullscreen();
    } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) {
        elem.msRequestFullscreen();
    }
}

window.addEventListener('load', function() {
    enterFullscreen();
});

document.addEventListener('fullscreenchange', function() {
    if (!document.fullscreenElement) {
        alert('Warning: You have exited fullscreen mode. Please return to fullscreen to continue the quiz.');
        enterFullscreen();
    }
});

document.addEventListener('webkitfullscreenchange', function() {
    if (!document.webkitFullscreenElement) {
        alert('Warning: You have exited fullscreen mode. Please return to fullscreen to continue the quiz.');
        enterFullscreen();
    }
});

let focusWarningCount = 0;
const MAX_WARNINGS = 4;

window.addEventListener('blur', function() {
    focusWarningCount++;
    if (focusWarningCount >= MAX_WARNINGS) {
        alert('Warning #' + focusWarningCount + ': Maximum warnings reached! Your quiz will be auto-submitted now.');
        document.getElementById('quizForm').submit();
    } else {
        alert('Warning #' + focusWarningCount + ' of ' + MAX_WARNINGS + ': You switched away from the quiz window. Please stay focused on the quiz! One more warning and your quiz will be auto-submitted.');
    }
});

document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        focusWarningCount++;
        if (focusWarningCount >= MAX_WARNINGS) {
            alert('Warning #' + focusWarningCount + ': Maximum warnings reached! Your quiz will be auto-submitted now.');
            document.getElementById('quizForm').submit();
        } else {
            alert('Warning #' + focusWarningCount + ' of ' + MAX_WARNINGS + ': You switched to another tab. Please stay on the quiz tab! One more warning and your quiz will be auto-submitted.');
        }
    }
});
</script>
{% endblock %}
